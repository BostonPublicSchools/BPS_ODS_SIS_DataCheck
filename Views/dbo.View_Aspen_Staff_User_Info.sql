SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

CREATE VIEW [dbo].[View_Aspen_Staff_User_Info]
AS


SELECT DISTINCT ROW_NUMBER() OVER (
        PARTITION BY psn.PSN_OID ORDER BY psn.PSN_OID
        ) AS [#]
    , COUNT(*) OVER (PARTITION BY psn.PSN_OID) AS [OF]
    , usr.USR_OID
    , psn.PSN_OID
    , stf.STF_OID
    , usr.USR_NAME_VIEW [Name]
    , stf.STF_ID_LOCAL [EmployeeID]
    , stf.STF_STATUS [EmplStatus]
    , usr.USR_LOGIN_NAME [LoginName]
    , usr.USR_LOGIN_STATUS [LoginStatus]
    , CASE
        WHEN usr.USR_LOGIN_STATUS = 0 THEN 'Active'
        WHEN usr.USR_LOGIN_STATUS = 1 THEN 'Disabled but allow re-enable from password recovery'
        WHEN usr.USR_LOGIN_STATUS = 2 THEN 'Disabled and locked'
        ELSE CAST(usr.USR_LOGIN_STATUS AS VARCHAR(10))
    END AS [LoginStatusDesc]
    , CASE 
        WHEN usr.USR_AUTHENTICATION_TYPE = 1
            THEN 'Active Directory (AD)'
        ELSE 'Aspen'
        END [LoginAuthType]
    , COUNT(1) [LoginCount]
    -- , CONVERT(VARCHAR(10),MIN(ual.UAL_START_DATE),121) [LoginFirst]
    -- , CONVERT(VARCHAR(10),MAX(ual.UAL_START_DATE),121) [LoginLast]
    , MIN(ual.UAL_START_DATE) [LoginFirst]
    , MAX(ual.UAL_START_DATE) [LoginLast]
    , psn.PSN_EMAIL_01 [Email01]
FROM [BPSDATA-03].[ExtractAspen].[dbo].USER_INFO usr
LEFT JOIN [BPSDATA-03].[ExtractAspen].[dbo].USER_ACCESS_LOG ual
    ON ual.UAL_USR_OID = usr.USR_OID
JOIN [BPSDATA-03].[ExtractAspen].[dbo].PERSON psn
    ON usr.USR_PSN_OID = psn.PSN_OID
JOIN [BPSDATA-03].[ExtractAspen].[dbo].STAFF stf
    ON stf.STF_PSN_OID = usr.USR_PSN_OID
-- WHERE stf.STF_ID_LOCAL IN (
--     -- '124925','125004','X03887','X03719','X03690','X03724','X03900','136534','135840','X02706','x01330','X03081','X04309','X03344','083154','X04394','145898','146627','X04628','X04640','X05166','123456789','X05281','X05287','X05284','X05286','X05292','X05290','X05295','X05288','X05289','X05300','X05303','X05302','X05305','X05304','X05333','X05334','X05337','X05350','X05344','X05358','X05359','X05354','X05351','X05386','X05380','X05389','X05399','X05402','X05401','X05403','X05405','X05409','X05423','X05421','X05420','X05429','X05430','X05435','X05439','X05438','X05442','X05452','40001137','40001139','X03815','X03842','042903','137117','X04511','X05045','X05075','X05158','X01388','X05210','X05212','X05213','X05206','X00003','X03630','X03629','X03717','X03725','X03737','X04350','x02184','X04313','X05074','X05105','X04610','X05149','130436','X05193','X05199','X05198','X04574','X05280','X05282','X05285','X04736','X04735','X05293','X05294','X05248','X05296','X05297','X05298','X00546','X05301','X05299','X05306','X05335','X05338','X05341','X05348','X05349','X05347','X05346','X05342','X05343','X05357','X05353','X05356','X05355','X05385','X05387','X05392','X05391','X05396','X05397','X05400','X05393','X05407','X05404','X05410','X05417','X05424','X05422','X05427','X05433','X05434','X05432','X05441','X05440','091217','109093','X03981','081204','137161','137164','X04381','X05083','X05152','X05153','X05211','X05209','X05207','X05208','X05232','X05249','X05244','X05242','X05241','X05240','X05238','X05227','X05229','X05228','X05235','X05231','X05253','X05258','X05255','X05257','X05268','X05276','X05275','X05273','X05278','X05261','X05266','X04640','X04617','X04628','X04670','X04604','X04563','X05310','X05367','X05366','X05368','X05345','X04930','X05379','X05377','X05382','X05321','x05317','152033','X05454','X05456','X05458','X05464','X05465','40001082','40001083','X05473','40001155','40001153','40001156','40001154','40001152','X05487','X05483','X05481','X05482','40001165','X05490','X05489','X05500','X05515','X05512','X05514','X05519','X05522','X05518','X05516','40001177','X05526','X05525','X05524','X05510','X05509','X05506','X05532','X05534','X05529','X05537','X05530','X05204','X05205','X05214','X05247','037362','X05340','X05395','X05413','40001140','40001114','X05246','X04384','X05269','143533','X05263','X05460','X05491','X05497','X05536','X05561','X05583','X05611','X05582','40000120','40000135','40001047','40001049','40001037','40001032','115489','X05623','40000015','40001547','40001551','40001552','40000178','40000149','40000150','40000187','40000148','40000193','40000040','40000210','142695','X04572','X05336','150326','X05239','X05226','X05270','X05463','X05492','X05535','X05552','X05549','X05547','X05546','40000134','030174','x01033','40001548','40001549','40001550','40000067','40000106','40000198','40001024','037000','104060','x02161','X02892','X05243','X05237','X05236','X05215','X05217','X05245','X05224','X05225','X05233','X05234','X05254','X04679','X05271','X05272','X05274','X05277','X05279','X05262','X05259','X05265','X04625','X04621','X04623','X04663','X04662','X04665','X04593','X04594','X04610','X04579','144293','X05311','X05326','X05325','X05313','X05312','X05324','X05323','X05365','X05370','X05371','X05381','X05378','X05461','X05459','X05457','X02113','X05453','X05451','40001145','X05474','X05471','X05472','40001157','X05486','X05484','X05485','X05477','X05476','X05478','X05496','X05495','X05493','X05488','X05499','X05513','X05517','X05508','40001178','40001176','X05528','X05527','40001179','X05511','X05507','X05531','X05533','X05539','X05538','X05554','X05553','X05556','X05557','X05540','X05551','X05550','X05560','X05558','X05559','X05565','X05564','X05568','X05566','X05580','X05577','X05586','X05608','X05613','X05590','X05587','X05589','X05597','X05596','X05598','X05593','X05595','X05591','X05603','X05600','X05601','40001452','40000119','40000122','40000121','40000166','40001051','40001084','40001028','40001111','023244','X03610','107221','X03873','116472','x00720','x01740','x01813','X05462','40001081','40001030','X05637','X05634','X05620','X05622','X05628','X05626','40000039','40000037','40000051','40000050','40000042','40001546','40000089','40001663','40000153','40000195','40000190','40000209','40000212','40000152','40000147','40000156','40000161','40001023','40001025','40001026','X05543','X05548','X05545','X05544','X05572','X05569','X05567','X05571','X05579','X05574','X05584','X05588','X05576','X05592','X05594','X05599','X05604','X05606','40000058','40000109','40000116','40000118','40000035','40001048','40001029','40001110','40001112','031752','082642','x01328','x01706','x01837','x02158','X05618','X05638','X05636','X05635','X05619','X05621','X05624','40000014','40000029','40000033','40000047','40000049','40000048','40000043','40001562','40000065','40000092','40000088','40000087','40001635','40000179','40000176','40000180','40000159','40000197','40000191','40000154','40000158','40000155','40000108','40000110','X05498','40001092','40001094','40001091','40001095','036304','103272','107572','x02213','X02898','X02958','40001027','X00043','40001086','40001087','40001089','40001088','40001093','40001096','40001090','40001101','092096','094198','108354','x02473','X02536','X05120'
--     '037362','x04384','X04384'
-- )
GROUP BY USR_OID
    , psn.PSN_OID
    , stf.STF_OID
    , usr.USR_LOGIN_NAME
    , usr.USR_LOGIN_STATUS
    , psn.PSN_EMAIL_01
    , usr.USR_NAME_VIEW
    , stf.STF_ID_LOCAL
    , stf.STF_STATUS
    , usr.USR_AUTHENTICATION_TYPE

-- ORDER BY psn.PSN_OID
--     , stf.STF_ID_LOCAL
--     , usr.USR_LOGIN_NAME
;
GO
